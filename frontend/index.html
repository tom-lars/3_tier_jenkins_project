<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3-Tier Application</title>
    <style>
        /* Previous CSS remains the same */
    </style>
</head>
<body>
    <!-- Previous HTML structure remains the same -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const messagesListEl = document.getElementById('messagesList');
            const formStatusEl = document.getElementById('formStatus');
            const messagesStatusEl = document.getElementById('messagesStatus');
            
            // Configurable API endpoint with fallback
            const API_BASE_URL = window.ENV?.API_ENDPOINT || '/api/messages';
            
            // Enhanced status message function
            function showStatus(element, message, isError = false) {
                element.innerHTML = `
                    <div class="status ${isError ? 'error' : 'success'}">
                        ${message}
                        ${isError ? `<small>Check network connection</small>` : ''}
                    </div>
                `;
                setTimeout(() => {
                    element.innerHTML = '';
                }, 5000);
            }
            
            // Comprehensive fetch wrapper
            async function safeFetch(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        }
                    });
                    
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`HTTP error! Status: ${response.status}, Body: ${errorBody}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('Fetch Error:', {
                        url,
                        error: error.message,
                        stack: error.stack
                    });
                    throw error;
                }
            }
            
            // HTML escape function to prevent XSS
            function escapeHTML(str) {
                return str.replace(/[&<>'"]/g, 
                    tag => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        "'": '&#39;',
                        '"': '&quot;'
                    }[tag] || tag));
            }
            
            // Load messages function with retry mechanism
            async function fetchMessages(retries = 3) {
                messagesListEl.innerHTML = '<p>Loading messages...</p>';
                
                try {
                    console.log(`Fetching messages from: ${API_BASE_URL}`);
                    const data = await safeFetch(API_BASE_URL);
                    
                    if (data.length === 0) {
                        messagesListEl.innerHTML = '<p>No messages yet.</p>';
                        return;
                    }
                    
                    let messagesHtml = data.map(item => `
                        <div class="message-item">
                            <h3>${escapeHTML(item.name)}</h3>
                            <p>${escapeHTML(item.message)}</p>
                            <small>Email: ${escapeHTML(item.email)}</small>
                        </div>
                    `).join('');
                    
                    messagesListEl.innerHTML = messagesHtml;
                } catch (error) {
                    console.error('Message Fetch Error:', error);
                    
                    if (retries > 0) {
                        console.log(`Retrying fetch. Attempts left: ${retries - 1}`);
                        setTimeout(() => fetchMessages(retries - 1), 2000);
                    } else {
                        messagesListEl.innerHTML = `
                            <p>Error loading messages</p>
                            <small>${error.message}</small>
                        `;
                        showStatus(messagesStatusEl, 'Failed to load messages', true);
                    }
                }
            }
            
            // Form submission handler
            document.getElementById('messageForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const messageData = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    message: document.getElementById('message').value,
                };
                
                formStatusEl.innerHTML = '';
                
                try {
                    await safeFetch(API_BASE_URL, {
                        method: 'POST',
                        body: JSON.stringify(messageData)
                    });
                    
                    // Clear form
                    document.getElementById('messageForm').reset();
                    showStatus(formStatusEl, 'Message submitted successfully!');
                    
                    // Reload messages
                    fetchMessages();
                } catch (error) {
                    showStatus(formStatusEl, `Error: ${error.message}`, true);
                }
            });
            
            // Initial load and periodic refresh
            fetchMessages();
            setInterval(fetchMessages, 60000); // Refresh messages every minute
        });
    </script>
</body>
</html>